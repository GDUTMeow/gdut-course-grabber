name: Sync Releases to Private Repo

on:
  workflow_dispatch:
    inputs:
      org_name:
        description: 'GitHub Organization Name'
        required: true
        default: 'GDUTMeow'
      source_repo:
        description: 'Source repository name'
        required: true
        default: 'GDUTCourseGrabber'
      dest_repo:
        description: 'Destination repository name'
        required: true
        default: 'GDUTCourseGrabberP'

jobs:
  copy-releases-job:
    runs-on: ubuntu-latest
    name: Copy Releases from GDUTCourseGrabber

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install requests

      - name: Run Release Copier Script
        env:
          GITHUB_TOKEN: ${{ secrets.MIGRATION_PAT }}
          ORGANIZATION_NAME: ${{ github.event.inputs.org_name }}
          SOURCE_REPO_NAME: ${{ github.event.inputs.source_repo }}
          DEST_REPO_NAME: ${{ github.event.inputs.dest_repo }}
        run: |
          python -c """
            import os
            import sys
            import requests

            # --- 从环境变量读取配置 ---
            GITHUB_TOKEN = os.getenv('GITHUB_TOKEN')
            ORGANIZATION_NAME = os.getenv('ORGANIZATION_NAME')
            SOURCE_REPO_NAME = os.getenv('SOURCE_REPO_NAME')
            DEST_REPO_NAME = os.getenv('DEST_REPO_NAME')

            GITHUB_API_URL = "https://api.github.com"

            def copy_releases(token, org, source_repo, dest_repo):
                print(f"--- Starting Release Migration ---")
                print(f"Organization: {org}")
                print(f"Source Repo: {source_repo}")
                print(f"Destination Repo: {dest_repo}")
                print("----------------------------------")

                if not all([token, org, source_repo, dest_repo]):
                    print("Error: Missing one or more required environment variables (especially MIGRATION_PAT secret).")
                    sys.exit(1)

                headers = {
                    "Authorization": f"token {token}",
                    "Accept": "application/vnd.github.v3+json",
                }

                source_releases_url = f"{GITHUB_API_URL}/repos/{org}/{source_repo}/releases"
                print(f"Fetching releases from '{source_repo}'...")
                
                try:
                    response = requests.get(source_releases_url, headers=headers)
                    response.raise_for_status()
                except requests.exceptions.RequestException as err:
                    print(f"Error fetching releases from '{source_repo}'. Check repository name and token permissions.")
                    print(f"Error details: {err}")
                    sys.exit(1)
                    
                releases = response.json()
                
                if not releases:
                    print("No releases found in the source repository. Exiting.")
                    return

                print(f"Found {len(releases)} releases. Processing from oldest to newest...")

                for release in reversed(releases):
                    tag_name = release["tag_name"]
                    release_name = release.get("name") or tag_name
                    
                    print(f"\\nProcessing Release: '{release_name}' (Tag: {tag_name})...")

                    dest_releases_url = f"{GITHUB_API_URL}/repos/{org}/{dest_repo}/releases"
                    release_data = {
                        "tag_name": tag_name, "name": release["name"], "body": release["body"],
                        "prerelease": release["prerelease"], "draft": release["draft"],
                    }
                    
                    print(f"  > Creating release in '{dest_repo}'...")
                    try:
                        create_response = requests.post(dest_releases_url, headers=headers, json=release_data)
                        
                        if create_response.status_code == 422:
                            error_details = create_response.json()
                            if any("tag_name already exists" in str(e) for e in error_details.get("errors", [])):
                                print(f"  > Warning: Release for tag '{tag_name}' already exists. Skipping creation, will attempt to upload assets.")
                                existing_release_url = f"{dest_releases_url}/tags/{tag_name}"
                                get_existing_release = requests.get(existing_release_url, headers=headers)
                                new_release_data = get_existing_release.json() if get_existing_release.ok else None
                            else:
                                print(f"  > Error creating release '{release_name}': {error_details}")
                                continue
                        elif not create_response.ok:
                            print(f"  > Error creating release '{release_name}'. Status: {create_response.status_code}, Response: {create_response.text}")
                            continue
                        else:
                            print(f"  > Successfully created release '{release_name}'.")
                            new_release_data = create_response.json()

                        if not new_release_data:
                            print(f"  > Could not obtain release data for '{release_name}', cannot upload assets.")
                            continue

                        if "assets" in release and release["assets"]:
                            upload_url_template = new_release_data["upload_url"].split("{")[0]
                            
                            for asset in release["assets"]:
                                asset_name = asset["name"]
                                print(f"    - Downloading asset: {asset_name}...")
                                
                                asset_headers = headers.copy()
                                asset_headers["Accept"] = "application/octet-stream"
                                asset_response = requests.get(asset["url"], headers=asset_headers, stream=True, timeout=300)
                                asset_response.raise_for_status()

                                print(f"    - Uploading asset to release '{release_name}'...")
                                
                                upload_headers = headers.copy()
                                upload_headers["Content-Type"] = asset["content_type"]
                                upload_response = requests.post(f"{upload_url_template}?name={asset_name}", headers=upload_headers, data=asset_response.raw, timeout=300)
                                
                                if upload_response.ok:
                                    print(f"    - Asset '{asset_name}' uploaded successfully.")
                                else:
                                    print(f"    - Error uploading asset '{asset_name}'. Status: {upload_response.status_code}, Response: {upload_response.text}")

                    except requests.exceptions.RequestException as e:
                        print(f"  > Network error while processing release '{release_name}': {e}")
                        continue

                print("\\n--- All releases have been processed. ---")

            if __name__ == "__main__":
                copy_releases(
                    token=GITHUB_TOKEN,
                    org=ORGANIZATION_NAME,
                    source_repo=SOURCE_REPO_NAME,
                    dest_repo=DEST_REPO_NAME,
                )

            """
